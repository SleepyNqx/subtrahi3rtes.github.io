<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Local Excel — GitHub Save</title>
<style>
  :root{
    --bg:#071226;
    --panel:#081827;
    --muted:rgba(230,238,246,0.65);
    --accent:#41d3ff;
    --glow:0 0 18px rgba(65,211,255,0.12), 0 0 6px rgba(65,211,255,0.08);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#02060a, var(--bg));color:#e6eef6;min-height:100vh}
  .app{display:flex;gap:12px;padding:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--glow)}
  .sidebar{width:300px;flex-shrink:0;display:flex;flex-direction:column;gap:12px}
  .sheets{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .sheet-btn{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;background:transparent;transition:transform .15s, box-shadow .15s}
  .sheet-btn:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.6), 0 0 30px rgba(65,211,255,0.08);border-color:rgba(65,211,255,0.14)}
  .sheet-btn.active{background:linear-gradient(90deg, rgba(65,211,255,0.06), rgba(65,211,255,0.02));box-shadow:0 0 20px rgba(65,211,255,0.08)}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  button{background:linear-gradient(180deg,#0f2a35,#071a20);border:none;padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer;transition:transform .12s,box-shadow .12s}
  button:hover{transform:translateY(-3px);box-shadow:var(--glow)}
  button.danger{background:linear-gradient(180deg,#3b1a1a,#2a0f0f);color:#ffd6d6}
  .main{flex:1;display:flex;flex-direction:column;gap:12px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .search{margin-left:auto}
  .grid-wrap{overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.02)}
  table.sheet{border-collapse:collapse;width:max-content;min-width:100%}
  table.sheet td, table.sheet th{border:1px solid rgba(255,255,255,0.03);min-width:120px;padding:8px}
  table.sheet th{background:rgba(255,255,255,0.02);position:sticky;top:0;z-index:2}
  td[contenteditable]{outline:none;min-width:120px;transition:background .12s, box-shadow .12s}
  td[contenteditable]:hover{background:rgba(65,211,255,0.03);box-shadow:0 4px 18px rgba(65,211,255,0.04)}
  .meta-row{display:flex;gap:8px;align-items:center}
  .input, textarea, select{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:8px}
  .token-field{width:100%}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;padding:6px 8px}
  .glow-pill{padding:6px 8px;border-radius:999px;border:1px solid rgba(65,211,255,0.12);box-shadow:0 6px 30px rgba(65,211,255,0.03)}
  .hint{font-size:12px;color:rgba(230,238,246,0.55)}
  a.link{color:var(--accent);text-decoration:none}
  .status{font-size:13px}
  @media (max-width:900px){.app{flex-direction:column}.sidebar{width:100%}}
</style>
</head>
<body>
<div style="padding:14px 18px;">
  <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px">
    <h2 style="margin:0">Local Excel — GitHub Save</h2>
    <div class="muted">Save sheets directly to a GitHub repo</div>
  </div>

  <div class="app">
    <div class="sidebar card">
      <div style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <strong>Sheets</strong>
          <div class="status muted" id="saveStatus">Autosaved (local)</div>
        </div>
        <div class="sheets" id="sheets"></div>
      </div>

      <div class="controls" style="margin-top:8px">
        <button id="newSheet">New</button>
        <button id="renameSheet">Rename</button>
        <button id="deleteSheet" class="danger">Delete</button>
        <button id="clearSheet">Clear</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="muted">GitHub save</div>
        <input id="ghToken" class="input token-field" placeholder="Personal access token (paste here, not stored)" />
        <input id="ghOwner" class="input" placeholder="GitHub owner or org (e.g. you)" />
        <input id="ghRepo" class="input" placeholder="Repo name (e.g. local-excel)" />
        <input id="ghPath" class="input" placeholder="Path prefix (e.g. sheets/) or leave blank" />
        <div style="display:flex;gap:8px">
          <button id="saveToGH">Save active sheet to GitHub</button>
          <button id="saveAllToGH">Save all sheets</button>
        </div>
        <div class="hint">Files saved as JSON at <code>PATH/SheetName.json</code>. Existing files will be updated.</div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="muted">Local export / import</div>
        <div style="display:flex;gap:8px">
          <button id="exportAll">Export JSON</button>
          <button id="importAll">Import JSON</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="exportCSV">Export CSV</button>
          <label for="importCSV"><button id="importCSVLabel">Import CSV</button></label>
          <input id="importCSV" type="file" accept="text/csv" style="display:none"/>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div style="display:flex;gap:8px;align-items:center">
              <div id="sheetTitle" style="font-weight:600">Sheet 1</div>
              <div class="glow-pill muted" id="sheetPriority">Priority: Normal</div>
              <div class="hint" style="margin-left:8px">Comments: <span id="sheetComments" class="muted hint">—</span></div>
            </div>
            <div class="muted" style="margin-top:6px">Edit cells. Changes auto-save locally. Use GitHub to persist to repo.</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="findInput" class="input" placeholder="Find (press Enter)" />
            <div>
              <button id="addRow">Add row</button>
              <button id="addCol">Add col</button>
              <button id="delRow">Del row</button>
              <button id="delCol">Del col</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div class="muted">Priority</div>
          <select id="prioritySelect" class="input small">
            <option value="Low">Low</option>
            <option value="Normal" selected>Normal</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
          <div class="muted">Comments</div>
          <input id="commentsInput" class="input" placeholder="Short note for this sheet" style="flex:1"/>
        </div>
      </div>

      <div class="grid-wrap card" id="gridWrap">
        <table class="sheet" id="sheetTable"></table>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Features:
  - sheets: {name, priority, comments, data[][]}
  - autosave localStorage
  - save to GitHub via REST API (requires token input)
  - add hover + glow effects via CSS
*/

/* Storage and default */
const STORAGE_KEY = 'localExcel.github.v1';
let state = { sheets: [], active: 0 };
function defaultSheet(name='Sheet1', rows=10, cols=6){
  const data = []; for(let r=0;r<rows;r++) data.push(new Array(cols).fill(''));
  return { name, priority:'Normal', comments:'', data };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ state = JSON.parse(raw); }
    if(!state.sheets || state.sheets.length===0) state = { sheets:[defaultSheet('Sheet1')], active:0 };
  }catch(e){ console.error(e); state = { sheets:[defaultSheet('Sheet1')], active:0 }; }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  document.getElementById('saveStatus').textContent = 'Saved (local) ' + new Date().toLocaleTimeString();
}

/* Render UI */
const sheetsEl = document.getElementById('sheets');
const tableEl = document.getElementById('sheetTable');
function renderSheetsList(){
  sheetsEl.innerHTML = '';
  state.sheets.forEach((s,i)=>{
    const btn = document.createElement('div');
    btn.className = 'sheet-btn' + (i===state.active ? ' active':'');
    btn.innerHTML = `<div style="font-weight:600">${s.name}</div><div class="muted">${s.priority}</div>`;
    btn.onclick = ()=>{ state.active = i; render(); saveState(); };
    sheetsEl.appendChild(btn);
  });
}

function renderTable(){
  const sheet = state.sheets[state.active];
  if(!sheet) return;
  document.getElementById('sheetTitle').textContent = sheet.name;
  document.getElementById('sheetPriority').textContent = 'Priority: ' + sheet.priority;
  document.getElementById('sheetComments').textContent = sheet.comments || '—';
  document.getElementById('prioritySelect').value = sheet.priority;
  document.getElementById('commentsInput').value = sheet.comments || '';

  const rows = sheet.data.length; const cols = sheet.data[0]?.length || 0;
  tableEl.innerHTML = '';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.appendChild(document.createElement('th'));
  for(let c=0;c<cols;c++){
    const th = document.createElement('th'); th.textContent = colLabel(c);
    headRow.appendChild(th);
  }
  thead.appendChild(headRow); tableEl.appendChild(thead);

  const tbody = document.createElement('tbody');
  for(let r=0;r<rows;r++){
    const tr = document.createElement('tr');
    const rowHead = document.createElement('th'); rowHead.textContent = r+1; tr.appendChild(rowHead);
    for(let c=0;c<cols;c++){
      const td = document.createElement('td');
      td.contentEditable = true;
      td.dataset.r = r; td.dataset.c = c;
      td.textContent = sheet.data[r][c] || '';
      td.addEventListener('input', onCellInput);
      td.addEventListener('keydown', onCellKeyDown);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tableEl.appendChild(tbody);
}

/* helpers */
function colLabel(n){ let s=''; n++; while(n>0){ let rem=(n-1)%26; s = String.fromCharCode(65+rem)+s; n = Math.floor((n-1)/26); } return s; }
function onCellInput(e){ const td = e.target; const r = +td.dataset.r; const c = +td.dataset.c; state.sheets[state.active].data[r][c] = td.textContent; saveState(); }
function onCellKeyDown(e){ if(e.key==='Tab'){ e.preventDefault(); const td=e.target; const r=+td.dataset.r, c=+td.dataset.c; focusCell(r,c+1); } }
function focusCell(r,c){ const sel = tableEl.querySelector('td[data-r=\"'+r+'\"][data-c=\"'+c+'\"]'); if(sel){ sel.focus(); placeCaretAtEnd(sel);} }
function placeCaretAtEnd(el){ const range = document.createRange(); const sel = window.getSelection(); range.selectNodeContents(el); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); }

/* table ops */
function addRow(){ const s = state.sheets[state.active]; const cols = s.data[0]?.length || 1; s.data.push(new Array(cols).fill('')); render(); saveState(); }
function addCol(){ const s = state.sheets[state.active]; s.data.forEach(r=>r.push('')); render(); saveState(); }
function delRow(){ const s = state.sheets[state.active]; if(s.data.length<=1) return; s.data.pop(); render(); saveState(); }
function delCol(){ const s = state.sheets[state.active]; if(s.data[0].length<=1) return; s.data.forEach(r=>r.pop()); render(); saveState(); }
function newSheet(){ const name = prompt('New sheet name','Sheet'+(state.sheets.length+1))||('Sheet'+(state.sheets.length+1)); state.sheets.push(defaultSheet(name)); state.active = state.sheets.length-1; render(); saveState(); }
function renameSheet(){ const name = prompt('Rename sheet', state.sheets[state.active].name)||state.sheets[state.active].name; state.sheets[state.active].name = name; render(); saveState(); }
function deleteSheet(){ if(state.sheets.length===1){ if(!confirm('Delete last sheet? This will clear it.')) return; state.sheets[0]=defaultSheet('Sheet1'); state.active=0; render(); saveState(); return; } if(!confirm('Delete this sheet?')) return; state.sheets.splice(state.active,1); state.active = Math.max(0,state.active-1); render(); saveState(); }
function clearSheet(){ if(!confirm('Clear sheet?')) return; const name = state.sheets[state.active].name; state.sheets[state.active] = defaultSheet(name,10,6); render(); saveState(); }

/* find */
document.getElementById('findInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const q=e.target.value.trim(); if(!q) return; const s=state.sheets[state.active]; for(let r=0;r<s.data.length;r++){ for(let c=0;c<s.data[0].length;c++){ if((s.data[r][c]||'').toString().includes(q)){ focusCell(r,c); return; } } } alert('Not found'); } });

/* priorities & comments */
document.getElementById('prioritySelect').addEventListener('change', (e)=>{ state.sheets[state.active].priority = e.target.value; render(); saveState(); });
document.getElementById('commentsInput').addEventListener('input', (e)=>{ state.sheets[state.active].comments = e.target.value; saveState(); });

/* import/export local */
function exportJSON(){ const data = JSON.stringify(state); const blob = new Blob([data],{type:'application/json'}); downloadBlob(blob,'local-excel-state.json'); }
function importJSON(){ const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = ()=>{ const f = input.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const parsed = JSON.parse(reader.result); if(parsed.sheets){ state = parsed; render(); saveState(); alert('Imported'); }else alert('Invalid file'); }catch(e){ alert('Invalid JSON'); }}; reader.readAsText(f); }; input.click(); }
function exportCSV(){ const s = state.sheets[state.active]; const rows = s.data.map(r => r.map(c=>escapeCSV(c)).join(',')); const csv = rows.join('\\n'); downloadBlob(new Blob([csv],{type:'text/csv'}), s.name.replace(/\\s+/g,'_') + '.csv'); }
document.getElementById('importCSV').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ const parsed = simpleParseCSV(reader.result); state.sheets[state.active].data = parsed; render(); saveState(); alert('CSV imported'); }; reader.readAsText(f); });
function simpleParseCSV(text){ const rows = text.split(/\\r?\\n/).filter(r=>r.length>0); return rows.map(r=> r.split(',')); }
function escapeCSV(val){ if(val==null) return ''; val = val.toString(); if(val.includes(',')||val.includes('\\n')||val.includes('"')) return '\"'+val.replace(/\"/g,'\"\"')+'\"'; return val; }
function downloadBlob(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

/* GitHub API helpers
   - User provides token (input), owner, repo, path prefix.
   - Save sheet as JSON file at path: prefix + encodeURIComponent(sheetName) + '.json'
   - If file exists, fetch SHA then PUT to update. If not, PUT without sha to create.
*/
async function ghFetch(path, token, method='GET', body=null){
  const url = `https://api.github.com/repos/${path}`;
  const opts = { method, headers: { Accept:'application/vnd.github.v3+json' } };
  if(token) opts.headers['Authorization'] = 'token ' + token;
  if(body) { opts.body = JSON.stringify(body); opts.headers['Content-Type']='application/json'; }
  const res = await fetch(url, opts);
  return res;
}

async function getFileSha(owner, repo, fullpath, token){
  const endpoint = `${owner}/${repo}/contents/${encodeURIComponent(fullpath)}`;
  const res = await ghFetch(endpoint, token, 'GET');
  if(res.status===200){ const j = await res.json(); return j.sha; }
  return null;
}

async function putFile(owner, repo, fullpath, contentStr, message, token, sha=null){
  const endpoint = `${owner}/${repo}/contents/${encodeURIComponent(fullpath)}`;
  const body = {
    message: message || 'Update sheet ' + fullpath,
    content: b64EncodeUnicode(contentStr),
    committer: { name: 'web-app', email: 'noreply@example.com' }
  };
  if(sha) body.sha = sha;
  const res = await ghFetch(endpoint, token, 'PUT', body);
  return res;
}

function b64EncodeUnicode(str) {
  // base64 encode unicode
  return btoa(unescape(encodeURIComponent(str)));
}

/* Save single sheet to GitHub */
async function saveActiveToGitHub(){
  const token = document.getElementById('ghToken').value.trim();
  const owner = document.getElementById('ghOwner').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  const prefix = document.getElementById('ghPath').value.trim();
  if(!token || !owner || !repo){ alert('Provide token, owner and repo'); return; }
  const sheet = state.sheets[state.active];
  const filename = (prefix ? prefix.replace(/\\/$/, '') + '/' : '') + sanitizeFileName(sheet.name) + '.json';
  document.getElementById('saveStatus').textContent = 'Saving to GitHub...';
  try{
    const sha = await getFileSha(owner, repo, filename, token);
    const contentStr = JSON.stringify(sheet, null, 2);
    const message = `Save sheet ${sheet.name} (via web app)`;
    const res = await putFile(owner, repo, filename, contentStr, message, token, sha);
    if(res.status===201 || res.status===200){
      document.getElementById('saveStatus').textContent = 'Saved to GitHub: ' + filename;
      alert('Saved to GitHub: ' + filename);
    }else{
      const j = await res.json(); console.error(j);
      alert('GitHub error: ' + (j.message || res.status));
      document.getElementById('saveStatus').textContent = 'GitHub save failed';
    }
  }catch(e){ console.error(e); alert('Error: ' + e.message); document.getElementById('saveStatus').textContent = 'GitHub save failed'; }
}

function sanitizeFileName(name){
  return name.replace(/[\\/?%*:|\"<>]/g, '-').replace(/\\s+/g, '_');
}

/* Save all sheets */
async function saveAllToGitHub(){
  const token = document.getElementById('ghToken').value.trim();
  const owner = document.getElementById('ghOwner').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  const prefix = document.getElementById('ghPath').value.trim();
  if(!token || !owner || !repo){ alert('Provide token, owner and repo'); return; }
  document.getElementById('saveStatus').textContent = 'Saving all to GitHub...';
  for(let i=0;i<state.sheets.length;i++){
    const sheet = state.sheets[i];
    const filename = (prefix ? prefix.replace(/\\/$/, '') + '/' : '') + sanitizeFileName(sheet.name) + '.json';
    try{
      const sha = await getFileSha(owner, repo, filename, token);
      const res = await putFile(owner, repo, filename, JSON.stringify(sheet, null, 2), `Save sheet ${sheet.name}`, token, sha);
      if(!(res.status===201 || res.status===200)) { const j=await res.json(); console.error('error saving', sheet.name, j); }
    }catch(e){ console.error('save error', e); }
  }
  document.getElementById('saveStatus').textContent = 'Saved all to GitHub';
  alert('Saved all sheets (attempted). Check repo.');
}

/* wiring */
loadState(); render();
function render(){ renderSheetsList(); renderTable(); }

document.getElementById('addRow').onclick = addRow;
document.getElementById('addCol').onclick = addCol;
document.getElementById('delRow').onclick = delRow;
document.getElementById('delCol').onclick = delCol;
document.getElementById('newSheet').onclick = newSheet;
document.getElementById('renameSheet').onclick = renameSheet;
document.getElementById('deleteSheet').onclick = deleteSheet;
document.getElementById('clearSheet').onclick = clearSheet;
document.getElementById('exportAll').onclick = exportJSON;
document.getElementById('importAll').onclick = importJSON;
document.getElementById('exportCSV').onclick = exportCSV;
document.getElementById('saveToGH').onclick = saveActiveToGitHub;
document.getElementById('saveAllToGH').onclick = saveAllToGitHub;

/* simple UI: show file name when clicking a sheet */
document.getElementById('importAll').addEventListener('click', importJSON);

/* keyboard ctrl+s to save to local */
window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveState(); alert('Saved locally'); } });

/* initial local save stamp */
saveState();

/* helpers for import JSON */
function importJSON(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = ()=>{ const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const parsed = JSON.parse(r.result); if(parsed.sheets){ state = parsed; render(); saveState(); alert('Imported'); } else alert('Invalid file'); }catch(e){ alert('Invalid JSON'); }}; r.readAsText(f); }; input.click();
}
</script>
</body>
</html>
